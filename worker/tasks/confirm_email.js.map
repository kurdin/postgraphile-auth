{"version":3,"file":"confirm_email.js","sourceRoot":"","sources":["confirm_email.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,qDAA+B;AAc/B,IAAM,yBAAyB,GAAG,UAChC,OAAgB;IAEhB,IAAM,YAAY,GAAG,OAAkC,CAAC;IACxD,OAAO,CACL,YAAY,CAAC,KAAK,KAAK,SAAS,IAAI,YAAY,CAAC,YAAY,KAAK,SAAS,CAC5E,CAAC;AACJ,CAAC,CAAC;AAEF,IAAM,IAAI,GAAS,UAAO,OAAO,EAAE,EAAU;QAAR,MAAM,YAAA;;;;;;oBACzC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,EAAE;wBACvC,OAAO,CAAC,IAAI,CAAC,6DAA6D,CAAC,CAAC;wBAC5E,sBAAO;qBACR;oBAEK,WAAW,GACf,gBAAM,CAAC,SAAS,8BACO,kBAAkB,CAAC,OAAO,CAAC,YAAY,CAAG,CAAC;oBAC9D,gBAAgB,GAAqB;wBACzC,OAAO,EAAE;4BACP,IAAI,EAAE,gBAAM,CAAC,gBAAgB;4BAC7B,EAAE,EAAE,OAAO,CAAC,KAAK;4BACjB,OAAO,EAAE,mCAAmC;yBAC7C;wBACD,YAAY,EAAE,oBAAoB;wBAClC,SAAS,EAAE;4BACT,WAAW,aAAA;yBACZ;qBACF,CAAC;oBACF,qBAAM,MAAM,CAAC,YAAY,EAAE,gBAAgB,CAAC,EAAA;;oBAA5C,SAA4C,CAAC;;;;;CAC9C,CAAC;AAEF,kBAAe,IAAI,CAAC","sourcesContent":["import { Task } from \"graphile-worker\";\nimport config from \"../config\";\nimport { SendEmailPayload } from \"./send_email\";\n\n// TODO: spam prevention\n\ninterface SendConfirmEmailPayload {\n  email: string;\n  confirmToken: string;\n}\n\nexport interface ConfirmEmailVariables {\n  confirmLink: string;\n}\n\nconst isSendConfirmEmailPayload = (\n  payload: unknown\n): payload is SendConfirmEmailPayload => {\n  const checkPayload = payload as SendConfirmEmailPayload;\n  return (\n    checkPayload.email !== undefined && checkPayload.confirmToken !== undefined\n  );\n};\n\nconst task: Task = async (payload, { addJob }) => {\n  if (!isSendConfirmEmailPayload(payload)) {\n    console.warn(\"Absent email address or confirm token: task payload ignored\");\n    return;\n  }\n\n  const confirmLink = `${\n    config.publicUrl\n  }/account/confirmemail/${encodeURIComponent(payload.confirmToken)}`;\n  const sendEmailPayload: SendEmailPayload = {\n    options: {\n      from: config.mailgunFromEmail,\n      to: payload.email,\n      subject: \"Please confirm your email address\",\n    },\n    templateName: \"confirm_email.mjml\",\n    variables: {\n      confirmLink,\n    },\n  };\n  await addJob(\"send_email\", sendEmailPayload);\n};\n\nexport default task;\n"]}